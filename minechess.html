<canvas id="ctx" width="500" height="500" style="border:1px solid #000000;">
</canvas>

<script>

	var ctx = document.getElementById("ctx").getContext("2d");
	
	Tile = function(x, y){
		var tile = {
			mine:0,
			status:1,
			surround:0,
			x_start:x,
			y_start:y
		};
		return tile;
	}

	document.onclick = function(mouse){
		for (var i = 0; i < board_size; i++){
			for (var j = 0; j < board_size; j++){
				if (mouse.clientX >= board[i][j].x_start && mouse.clientX <= board[i][j].x_start + tile_size - 1 && mouse.clientY >= board[i][j].y_start && mouse.clientY <= board[i][j].y_start + tile_size - 1){
					if (!game_start){
						game_start = true;
						createMines(board, i, j);
					}
					if (board[i][j].mine == 1){
						console.log("YOU LOSE!");
					}else{
						board[i][j].status = 0;
						var encountered = [];
						openSurround(board, i, j, encountered);
					}
					drawBoard(board);
				}
			}
		}
	}

	document.oncontextmenu = function(mouse){
		for (var i = 0; i < board_size; i++){
			for (var j = 0; j < board_size; j++){
				if (mouse.clientX >= board[i][j].x_start && mouse.clientX <= board[i][j].x_start + tile_size - 1 && mouse.clientY >= board[i][j].y_start && mouse.clientY <= board[i][j].y_start + tile_size - 1){
					board[i][j].status = 2;
					drawBoard(board);
				}
			}
		}
		return false;
	}

	createBoard = function(){
		var board = [];
		for (var i = 0; i < board_size; i++){
			board[i] = [];
			for (var j = 0; j < board_size; j++){
				board[i][j] = Tile(1 + tile_size * j, 1 + tile_size * i);
			}
		}
		return board;
	}

	drawBoard = function(board){
		ctx.clearRect(0, 0, 500, 500);
		for (var i = 0; i < board_size; i++){
			for (var j = 0; j < board_size; j++){
				var tile = board[i][j]
				if (tile.status == 2){
					ctx.fillStyle = 'red';
				}else if (tile.status == 3){
					ctx.fillStyle = 'blue';
				}
				if (tile.status > 0){
					ctx.fillRect(tile.x_start, tile.y_start, tile_size - 1, tile_size - 1);
				}else{
					ctx.fillText(tile.surround, tile.x_start + 15, tile.y_start + 15);
				}
				ctx.fillStyle = 'black';
			}
		}
	}

	createMines = function(board, start_row, start_col){
		var mine_spots = []
		for (i = 0; i < 3; i++){
			for (j = 0; j < 3; j++){
				mine_spots.push((start_row-1+i)*board_size+(start_col-1+j))
			}
		}
		for (var i = 0; i < mine_count; i++){
			var spot = Math.floor(Math.random() * 256);
			while (mine_spots.includes(spot)){
				spot = Math.floor(Math.random() * 256);
			}
			board[Math.floor(spot / board_size)][spot % board_size].mine = 1;
			//board[Math.floor(spot / board_size)][spot % board_size].status = 2;
			mine_spots.push(spot);
		}
		for (var i = 0; i < board_size; i++){
			for (var j = 0; j < board_size; j++){
				board[i][j].surround = checkSurround(board, i, j);
			}
		}
		mine_spots = mine_spots.splice(0, 9);
	}

	openSurround = function(board, x, y, encountered){
		if (!encountered.includes(board[x][y]) && board[x][y].surround == 0){
			encountered.push(board[x][y]);
			for (var i = 0; i < 3; i++){
				for (var j = 0; j < 3; j++){
					if (x-1+i >= 0 && x-1+i < board_size && y-1+j >= 0 && y-1+j < board_size){
						if (board[x-1+i][y-1+j].mine == 0){
							board[x-1+i][y-1+j].status = 0;
							openSurround(board, x-1+i, y-1+j, encountered);
						}
					}
				}
			}
		}
	}

	checkSurround = function(board, x, y){
		var count = 0;
		for (var i = 0; i < 3; i++){
			for (var j = 0; j < 3; j++){
				if (x-1+i >= 0 && x-1+i < board_size && y-1+j >= 0 && y-1+j < board_size){
					if (board[x-1+i][y-1+j].mine == 1){
						count++;
					}
				}
			}
		}
		return count;
	}

	var game_start = false;
	var board_size = 16;
	var tile_size = 30;
	var mine_count = 40;
	var board = createBoard();
	drawBoard(board);


</script>