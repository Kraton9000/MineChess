<canvas id="ctx" width="600" height="500" style="border:1px solid #000000;">
</canvas>

<script>

	var cvs = document.getElementById("ctx")
	var ctx = cvs.getContext("2d");
	
	Tile = function(x, y){
		var tile = {
			mine:0,
			status:1,
			surround:0,
			x_start:x,
			y_start:y,
			row:null,
			col:null
		};
		return tile;
	}

	Piece = function(name, colour, x, y){
		var piece = {
			name:name,
			alive:true,
			colour:colour,
			x_start:x,
			y_start:y
		};
		return piece;
	}

	function getMousePos(canvas, evt) {
	    var rect = canvas.getBoundingClientRect();
	    return {
	      x: evt.clientX - rect.left,
	      y: evt.clientY - rect.top
	    };
	}

	leftClickTile = function(mouse){
		for (var i = 0; i < board_size; i++){
			for (var j = 0; j < board_size; j++){
				if (mouse.x >= board[i][j].x_start && mouse.x <= board[i][j].x_start + tile_size - 1 && mouse.y >= board[i][j].y_start && mouse.y <= board[i][j].y_start + tile_size - 1){
					if (!game_start){
						game_start = true;
						createMines(board, i, j);
					}
					if (board[i][j].mine == 1){
						console.log("YOU LOSE!");
					}else{
						board[i][j].status = 0;
						var encountered = [];
						openSurround(board, i, j, encountered);
					}
				}
			}
		}
	}

	leftClickPiece = function(mouse){
		if (hoverPiece == null){
			for (var i = 0; i < roster.length; i++){
				if (mouse.x >= roster[i].x_start && mouse.x <= roster[i].x_start + tile_size - 1 && mouse.y >= roster[i].y_start && mouse.y <= roster[i].y_start + tile_size - 1){
					hoverPiece = roster[i];
					break;
				}
			}
		}else{
			hoverPiece.row = Math.floor(mouse.y / tile_size)
			hoverPiece.col = Math.floor(mouse.x / tile_size)
			var tile = board[hoverPiece.row][hoverPiece.col];
			hoverPiece.x_start = tile.x_start;
			hoverPiece.y_start = tile.y_start;
			hoverPiece = null;
			setup = true;
		}
		console.log(hoverPiece);
	}

	leftClickTilePiece = function(mouse){
		for (var i = 0; i < roster.length; i++){
			if (mouse.x >= roster[i].x_start && mouse.x <= roster[i].x_start + tile_size - 1 && mouse.y >= roster[i].y_start && mouse.y <= roster[i].y_start + tile_size - 1){
				displayValidMoves(board, roster[i]);
			}
		}
	}

	document.onclick = function(mouse){
		var abs_mouse = getMousePos(cvs, mouse);
		if (!setup){
			leftClickTile(abs_mouse);
			leftClickPiece(abs_mouse);
		}else{
			leftClickTilePiece(abs_mouse);
		}
		drawBoard(board);
	}

	document.oncontextmenu = function(mouse){
		var abs_mouse = getMousePos(cvs, mouse);
		for (var i = 0; i < board_size; i++){
			for (var j = 0; j < board_size; j++){
				if (abs_mouse.x >= board[i][j].x_start && abs_mouse.x <= board[i][j].x_start + tile_size - 1 && abs_mouse.y >= board[i][j].y_start && abs_mouse.y <= board[i][j].y_start + tile_size - 1){
					board[i][j].status = 2;
					drawBoard(board);
				}
			}
		}
		return false;
	}

	document.onmousemove = function(mouse){
		var abs_mouse = getMousePos(cvs, mouse);
		if (hoverPiece != null){
			hoverPiece.x_start = abs_mouse.x - tile_size / 2;
			hoverPiece.y_start = abs_mouse.y - tile_size / 2;
			drawBoard(board);
		}
	}

	createBoard = function(){
		var board = [];
		for (var i = 0; i < board_size; i++){
			board[i] = [];
			for (var j = 0; j < board_size; j++){
				board[i][j] = Tile(1 + tile_size * j, 1 + tile_size * i);
			}
		}
		return board;
	}

	drawBoard = function(board){
		ctx.clearRect(0, 0, 600, 500);
		for (var i = 0; i < board_size; i++){
			for (var j = 0; j < board_size; j++){
				var tile = board[i][j]
				if (tile.status == 2){
					ctx.fillStyle = 'red';
				}else if (tile.status == 3){
					ctx.fillStyle = 'blue';
				}
				if (tile.status > 0){
					ctx.fillRect(tile.x_start, tile.y_start, tile_size - 1, tile_size - 1);
				}else{
					ctx.fillText(tile.surround, tile.x_start + 15, tile.y_start + 15);
				}
				ctx.fillStyle = 'black';
			}
		}
		for (var i = 0; i < roster.length; i++){
			ctx.fillStyle = roster[i].colour;
			ctx.fillRect(roster[i].x_start, roster[i].y_start, tile_size - 1, tile_size - 1);
		}
		ctx.fillStyle = 'black';
	}

	createMines = function(board, start_row, start_col){
		var mine_spots = []
		for (i = 0; i < 3; i++){
			for (j = 0; j < 3; j++){
				mine_spots.push((start_row-1+i)*board_size+(start_col-1+j))
			}
		}
		for (var i = 0; i < mine_count; i++){
			var spot = Math.floor(Math.random() * 256);
			while (mine_spots.includes(spot)){
				spot = Math.floor(Math.random() * 256);
			}
			board[Math.floor(spot / board_size)][spot % board_size].mine = 1;
			mine_spots.push(spot);
		}
		for (var i = 0; i < board_size; i++){
			for (var j = 0; j < board_size; j++){
				board[i][j].surround = checkSurround(board, i, j);
			}
		}
		mine_spots = mine_spots.splice(0, 9);
	}

	openSurround = function(board, x, y, encountered){
		if (!encountered.includes(board[x][y]) && board[x][y].surround == 0){
			encountered.push(board[x][y]);
			for (var i = 0; i < 3; i++){
				for (var j = 0; j < 3; j++){
					if (x-1+i >= 0 && x-1+i < board_size && y-1+j >= 0 && y-1+j < board_size){
						if (board[x-1+i][y-1+j].mine == 0){
							board[x-1+i][y-1+j].status = 0;
							openSurround(board, x-1+i, y-1+j, encountered);
						}
					}
				}
			}
		}
	}

	checkSurround = function(board, x, y){
		var count = 0;
		for (var i = 0; i < 3; i++){
			for (var j = 0; j < 3; j++){
				if (x-1+i >= 0 && x-1+i < board_size && y-1+j >= 0 && y-1+j < board_size){
					if (board[x-1+i][y-1+j].mine == 1){
						count++;
					}
				}
			}
		}
		return count;
	}

	loadChessPieces = function(){
		var roster = [];
		roster.push(Piece("Knight", "green", 550, 10 + 1*40));
		roster.push(Piece("Bishop", "blue", 550, 10 + 2*40));
		roster.push(Piece("Rook", 'red', 550, 10 + 3*40));
		roster.push(Piece("Queen", 'yellow', 550, 10 + 4*40));
		roster.push(Piece("King", 'orange', 550, 10 + 5*40));
		return roster;
	}

	displayValidMoves = function(board, piece){
		if (piece.name == "Rook"){
			for (i = 0; i < board_size; i++){
				if (board[i][piece.col].status != 0 && i != piece.row){
					board[i][piece.col].status = 2;
				}
			}
			for (i = 0; i < board_size; i++){
				if (board[piece.row][i].status != 0 && i != piece.col){
					board[piece.row][i].status = 2;
				}
			}
		}
	}

	var game_start = false;
	var setup = false;
	var board_size = 16;
	var tile_size = 30;
	var mine_count = 40;
	var hoverPiece = null;
	var board = createBoard();
	var roster = loadChessPieces();
	drawBoard(board);


</script>